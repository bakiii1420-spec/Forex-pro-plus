<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FX Pulse Pro - Forex Trading Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg-primary: #0a0e17;
      --bg-secondary: #0f1629;
      --bg-tertiary: #151d30;
      --bg-card: #1a2332;
      --accent-green: #00d26a;
      --accent-green-dim: rgba(0, 210, 106, 0.15);
      --accent-red: #ff4757;
      --accent-red-dim: rgba(255, 71, 87, 0.15);
      --accent-blue: #3498ff;
      --accent-blue-dim: rgba(52, 152, 255, 0.15);
      --accent-yellow: #ffc107;
      --accent-purple: #9b59b6;
      --text-primary: #e8eaed;
      --text-secondary: #8b95a5;
      --text-muted: #5a6270;
      --border-color: #2a3444;
      --border-light: #3a4555;
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
      --radius: 12px;
      --radius-sm: 8px;
      --transition: 0.2s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      width: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow: hidden;
    }

    .app {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 0 16px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 18px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .header-center {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-tab {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      border: none;
      background: transparent;
    }

    .nav-tab:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .nav-tab.active {
      background: var(--accent-blue-dim);
      color: var(--accent-blue);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .clock {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--bg-tertiary);
      border-radius: 20px;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: var(--accent-green);
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-green), #00b359);
      color: #000;
    }

    .btn-primary:hover {
      filter: brightness(1.1);
      transform: translateY(-1px);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .btn-outline:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-light);
    }

    /* Main Layout */
    .main {
      flex: 1;
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      grid-template-rows: 1fr;
      gap: 1px;
      background: var(--border-color);
      min-height: 0;
    }

    @media (max-width: 1200px) {
      .main {
        grid-template-columns: 240px 1fr 280px;
      }
    }

    @media (max-width: 900px) {
      .main {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
      }
      .sidebar-left, .sidebar-right {
        max-height: 200px;
      }
    }

    /* Sidebar Left - Watchlist */
    .sidebar-left {
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .panel-header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .panel-title {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 10px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    .badge-live {
      background: var(--accent-green-dim);
      color: var(--accent-green);
    }

    .search-box {
      margin: 10px 12px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 8px 12px 8px 32px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 12px;
      outline: none;
      transition: var(--transition);
    }

    .search-box input:focus {
      border-color: var(--accent-blue);
    }

    .search-box::before {
      content: "üîç";
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
    }

    .watchlist {
      flex: 1;
      overflow-y: auto;
      padding: 0 8px 8px;
    }

    .watchlist-item {
      display: grid;
      grid-template-columns: 1fr auto auto;
      align-items: center;
      gap: 8px;
      padding: 10px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      margin-bottom: 2px;
    }

    .watchlist-item:hover {
      background: var(--bg-tertiary);
    }

    .watchlist-item.active {
      background: var(--accent-blue-dim);
      border: 1px solid rgba(52, 152, 255, 0.3);
    }

    .pair-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pair-flags {
      font-size: 14px;
    }

    .pair-symbol {
      font-weight: 600;
      font-size: 13px;
    }

    .pair-name {
      font-size: 10px;
      color: var(--text-muted);
    }

    .pair-price {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
      font-weight: 500;
      text-align: right;
    }

    .pair-change {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 6px;
      font-weight: 500;
      min-width: 65px;
      text-align: center;
    }

    .pair-change.positive {
      background: var(--accent-green-dim);
      color: var(--accent-green);
    }

    .pair-change.negative {
      background: var(--accent-red-dim);
      color: var(--accent-red);
    }

    /* Center - Chart Area */
    .center-panel {
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .chart-header {
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .chart-pair-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .chart-pair-main {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chart-pair-main .flags {
      font-size: 24px;
    }

    .chart-pair-details h2 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .chart-pair-details span {
      font-size: 11px;
      color: var(--text-muted);
    }

    .chart-price-info {
      text-align: right;
    }

    .chart-current-price {
      font-size: 24px;
      font-weight: 700;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .chart-price-change {
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-end;
    }

    .chart-price-change.positive { color: var(--accent-green); }
    .chart-price-change.negative { color: var(--accent-red); }

    .chart-toolbar {
      padding: 8px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }

    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .toolbar-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      color: var(--text-secondary);
      background: transparent;
      border: 1px solid transparent;
      cursor: pointer;
      transition: var(--transition);
    }

    .toolbar-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .toolbar-btn.active {
      background: var(--accent-blue-dim);
      color: var(--accent-blue);
      border-color: rgba(52, 152, 255, 0.3);
    }

    .toolbar-divider {
      width: 1px;
      height: 20px;
      background: var(--border-color);
      margin: 0 8px;
    }

    .indicator-tags {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .indicator-tag {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      transition: var(--transition);
    }

    .indicator-tag.active {
      background: var(--accent-purple);
      color: white;
    }

    .indicator-tag .remove {
      margin-left: 2px;
      opacity: 0.7;
    }

    .chart-container {
      flex: 1;
      position: relative;
      min-height: 200px;
    }

    .chart-container canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .chart-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      pointer-events: none;
    }

    .chart-stat {
      background: rgba(15, 22, 41, 0.9);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border-color);
    }

    .chart-stat-label {
      color: var(--text-muted);
    }

    .chart-stat-value {
      font-weight: 600;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .ohlc-display {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(15, 22, 41, 0.9);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 11px;
      border: 1px solid var(--border-color);
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .ohlc-item {
      text-align: center;
    }

    .ohlc-label {
      color: var(--text-muted);
      font-size: 10px;
      margin-bottom: 2px;
    }

    .ohlc-value {
      font-family: 'SF Mono', Monaco, monospace;
      font-weight: 500;
    }

    .chart-bottom-bar {
      padding: 10px 16px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .market-stats {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .stat-item .label {
      color: var(--text-muted);
    }

    .stat-item .value {
      font-weight: 500;
      font-family: 'SF Mono', Monaco, monospace;
    }

    /* Sidebar Right - Trading Panel */
    .sidebar-right {
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
    }

    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 2px solid transparent;
      background: transparent;
      border-top: none;
      border-left: none;
      border-right: none;
    }

    .tab:hover {
      color: var(--text-primary);
      background: var(--bg-tertiary);
    }

    .tab.active {
      color: var(--accent-blue);
      border-bottom-color: var(--accent-blue);
    }

    .tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .tab-pane {
      display: none;
    }

    .tab-pane.active {
      display: block;
    }

    /* Trade Form */
    .trade-direction {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }

    .direction-btn {
      padding: 14px;
      border-radius: 10px;
      border: 2px solid var(--border-color);
      background: var(--bg-tertiary);
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
    }

    .direction-btn:hover {
      border-color: var(--border-light);
    }

    .direction-btn.buy.active {
      border-color: var(--accent-green);
      background: var(--accent-green-dim);
    }

    .direction-btn.sell.active {
      border-color: var(--accent-red);
      background: var(--accent-red-dim);
    }

    .direction-btn .price {
      font-size: 18px;
      font-weight: 700;
      font-family: 'SF Mono', Monaco, monospace;
      margin-bottom: 4px;
    }

    .direction-btn.buy .price { color: var(--accent-green); }
    .direction-btn.sell .price { color: var(--accent-red); }

    .direction-btn .label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 14px;
      font-family: 'SF Mono', Monaco, monospace;
      outline: none;
      transition: var(--transition);
    }

    .form-input:focus {
      border-color: var(--accent-blue);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .input-with-icon {
      position: relative;
    }

    .input-with-icon .icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
    }

    .quick-lots {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .quick-lot {
      flex: 1;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-size: 11px;
      cursor: pointer;
      transition: var(--transition);
    }

    .quick-lot:hover {
      border-color: var(--accent-blue);
      color: var(--accent-blue);
    }

    .trade-summary {
      background: var(--bg-tertiary);
      border-radius: 10px;
      padding: 12px;
      margin: 16px 0;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      font-size: 12px;
    }

    .summary-row .label {
      color: var(--text-secondary);
    }

    .summary-row .value {
      font-weight: 500;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .summary-row.total {
      border-top: 1px solid var(--border-color);
      margin-top: 6px;
      padding-top: 10px;
      font-size: 13px;
    }

    .submit-trade {
      width: 100%;
      padding: 14px;
      border-radius: 10px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .submit-trade.buy {
      background: linear-gradient(135deg, var(--accent-green), #00b359);
      color: #000;
    }

    .submit-trade.sell {
      background: linear-gradient(135deg, var(--accent-red), #e6414f);
      color: #fff;
    }

    .submit-trade:hover {
      filter: brightness(1.1);
      transform: translateY(-1px);
    }

    /* Positions Tab */
    .positions-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .position-card {
      background: var(--bg-tertiary);
      border-radius: 10px;
      padding: 12px;
      border: 1px solid var(--border-color);
    }

    .position-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .position-pair {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .position-pair .flags {
      font-size: 16px;
    }

    .position-pair .symbol {
      font-weight: 600;
      font-size: 14px;
    }

    .position-dir {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .position-dir.buy {
      background: var(--accent-green-dim);
      color: var(--accent-green);
    }

    .position-dir.sell {
      background: var(--accent-red-dim);
      color: var(--accent-red);
    }

    .position-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      font-size: 11px;
    }

    .position-detail {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .position-detail .label {
      color: var(--text-muted);
    }

    .position-detail .value {
      font-weight: 500;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .position-pnl {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .pnl-value {
      font-size: 16px;
      font-weight: 700;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .pnl-value.positive { color: var(--accent-green); }
    .pnl-value.negative { color: var(--accent-red); }

    .close-position {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--accent-red);
      background: transparent;
      color: var(--accent-red);
      font-size: 11px;
      cursor: pointer;
      transition: var(--transition);
    }

    .close-position:hover {
      background: var(--accent-red-dim);
    }

    /* Alerts Tab */
    .alert-form {
      background: var(--bg-tertiary);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 16px;
    }

    .alerts-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .alert-item {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-left: 3px solid var(--accent-yellow);
    }

    .alert-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .alert-pair {
      font-weight: 600;
      font-size: 13px;
    }

    .alert-condition {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .alert-delete {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
      transition: var(--transition);
    }

    .alert-delete:hover {
      color: var(--accent-red);
    }

    /* Account Summary */
    .account-summary {
      background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-card));
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
    }

    .account-balance {
      text-align: center;
      margin-bottom: 16px;
    }

    .balance-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .balance-value {
      font-size: 28px;
      font-weight: 700;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .balance-change {
      font-size: 13px;
      margin-top: 4px;
    }

    .balance-change.positive { color: var(--accent-green); }
    .balance-change.negative { color: var(--accent-red); }

    .account-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .account-stat {
      text-align: center;
      padding: 10px;
      background: var(--bg-secondary);
      border-radius: 8px;
    }

    .account-stat .label {
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .account-stat .value {
      font-size: 14px;
      font-weight: 600;
      font-family: 'SF Mono', Monaco, monospace;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-muted);
    }

    .empty-state .icon {
      font-size: 40px;
      margin-bottom: 12px;
    }

    .empty-state .title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .empty-state .desc {
      font-size: 12px;
    }

    /* Toast Notification */
    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
    }

    .toast {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: var(--shadow);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
      pointer-events: none;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .toast-icon {
      font-size: 20px;
    }

    .toast-message {
      font-size: 13px;
    }

    .toast-close {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
      margin-left: 8px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-light);
    }

    .positive { color: var(--accent-green); }
    .negative { color: var(--accent-red); }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="logo">
        <div class="logo-icon">üìä</div>
        <div>FX Pulse Pro</div>
      </div>
      <div class="header-center">
        <button class="nav-tab active">Trading</button>
        <button class="nav-tab">Markets</button>
        <button class="nav-tab">Analysis</button>
        <button class="nav-tab">History</button>
      </div>
      <div class="header-right">
        <div class="clock">
          <span class="live-dot"></span>
          <span id="marketClock">00:00:00 UTC</span>
        </div>
        <button class="btn btn-outline" id="speedBtn">‚ö° 1x Speed</button>
        <button class="btn btn-primary">üíº Demo Account</button>
      </div>
    </header>

    <main class="main">
      <!-- Left Sidebar -->
      <aside class="sidebar-left">
        <div class="panel-header">
          <div class="panel-title">
            üìà Market Watch
            <span class="badge badge-live">LIVE</span>
          </div>
          <span class="badge" id="pairCount">12 pairs</span>
        </div>
        <div class="search-box">
          <input type="text" placeholder="Search pairs..." id="searchInput">
        </div>
        <div class="watchlist" id="watchlist"></div>
      </aside>

      <!-- Center Chart Area -->
      <section class="center-panel">
        <div class="chart-header">
          <div class="chart-pair-info">
            <div class="chart-pair-main">
              <span class="flags" id="chartFlags">üá™üá∫üá∫üá∏</span>
              <div class="chart-pair-details">
                <h2 id="chartPairName">EUR/USD</h2>
                <span id="chartPairDesc">Euro vs US Dollar ‚Ä¢ Major</span>
              </div>
            </div>
          </div>
          <div class="chart-price-info">
            <div class="chart-current-price" id="chartPrice">1.08500</div>
            <div class="chart-price-change positive" id="chartChange">
              <span>‚ñ≤ +0.00%</span>
              <span>(+0.00000)</span>
            </div>
          </div>
        </div>

        <div class="chart-toolbar">
          <div class="toolbar-group">
            <button class="toolbar-btn active" data-tf="1m">1M</button>
            <button class="toolbar-btn" data-tf="5m">5M</button>
            <button class="toolbar-btn" data-tf="15m">15M</button>
            <button class="toolbar-btn" data-tf="1h">1H</button>
            <button class="toolbar-btn" data-tf="4h">4H</button>
            <button class="toolbar-btn" data-tf="1d">1D</button>
            <div class="toolbar-divider"></div>
            <button class="toolbar-btn" data-style="line" id="lineBtn">üìà Line</button>
            <button class="toolbar-btn active" data-style="candle" id="candleBtn">üïØ Candles</button>
          </div>
          <div class="indicator-tags">
            <span class="indicator-tag" data-ind="ma" id="maTag">üìä MA(20) <span class="remove">√ó</span></span>
            <span class="indicator-tag" data-ind="ema" id="emaTag">üìâ EMA(50) <span class="remove">√ó</span></span>
            <span class="indicator-tag" data-ind="bb" id="bbTag">üìè Bollinger <span class="remove">√ó</span></span>
            <span class="indicator-tag active" data-ind="rsi" id="rsiTag">üì∂ RSI(14) <span class="remove">√ó</span></span>
          </div>
        </div>

        <div class="chart-container">
          <canvas id="mainChart"></canvas>
          <canvas id="rsiChart"></canvas>

          <div class="chart-overlay">
            <div class="chart-stat">
              <span class="chart-stat-label">Spread:</span>
              <span class="chart-stat-value" id="spreadValue">1.1 pips</span>
            </div>
            <div class="chart-stat">
              <span class="chart-stat-label">Vol 24h:</span>
              <span class="chart-stat-value" id="volValue">\$2.1T</span>
            </div>
          </div>

          <div class="ohlc-display" id="ohlcDisplay">
            <div class="ohlc-item">
              <div class="ohlc-label">Open</div>
              <div class="ohlc-value" id="oOpen">1.08450</div>
            </div>
            <div class="ohlc-item">
              <div class="ohlc-label">High</div>
              <div class="ohlc-value positive" id="oHigh">1.08620</div>
            </div>
            <div class="ohlc-item">
              <div class="ohlc-label">Low</div>
              <div class="ohlc-value negative" id="oLow">1.08380</div>
            </div>
            <div class="ohlc-item">
              <div class="ohlc-label">Close</div>
              <div class="ohlc-value" id="oClose">1.08500</div>
            </div>
          </div>
        </div>

        <div class="chart-bottom-bar">
          <div class="market-stats">
            <div class="stat-item">
              <span class="label">Bid:</span>
              <span class="value" id="bidPrice">1.08498</span>
            </div>
            <div class="stat-item">
              <span class="label">Ask:</span>
              <span class="value" id="askPrice">1.08502</span>
            </div>
            <div class="stat-item">
              <span class="label">Day Range:</span>
              <span class="value" id="dayRange">1.08200 - 1.08750</span>
            </div>
            <div class="stat-item">
              <span class="label">RSI(14):</span>
              <span class="value" id="rsiValue">52.4</span>
            </div>
          </div>
          <div class="stat-item">
            <span class="label">Session:</span>
            <span class="value" id="sessionLabel">üåç London</span>
          </div>
        </div>
      </section>

      <!-- Right Sidebar -->
      <aside class="sidebar-right">
        <div class="tabs">
          <button class="tab active" data-tab="trade">Trade</button>
          <button class="tab" data-tab="positions">Positions</button>
          <button class="tab" data-tab="alerts">Alerts</button>
        </div>

        <div class="tab-content">
          <!-- Trade Tab -->
          <div class="tab-pane active" id="tradePane">
            <div class="account-summary">
              <div class="account-balance">
                <div class="balance-label">DEMO BALANCE</div>
                <div class="balance-value" id="accountBalance">\$100,000.00</div>
                <div class="balance-change positive" id="accountChange">‚ñ≤ +\$0.00 (0.00%)</div>
              </div>
              <div class="account-stats">
                <div class="account-stat">
                  <div class="label">Equity</div>
                  <div class="value" id="equityValue">\$100,000.00</div>
                </div>
                <div class="account-stat">
                  <div class="label">Margin Used</div>
                  <div class="value" id="marginValue">\$0.00</div>
                </div>
                <div class="account-stat">
                  <div class="label">Free Margin</div>
                  <div class="value" id="freeMargin">\$100,000.00</div>
                </div>
                <div class="account-stat">
                  <div class="label">Open P/L</div>
                  <div class="value positive" id="openPnl">\$0.00</div>
                </div>
              </div>
            </div>

            <div class="trade-direction">
              <div class="direction-btn buy active" id="buyBtn">
                <div class="price" id="buyPrice">1.08502</div>
                <div class="label">Buy / Long</div>
              </div>
              <div class="direction-btn sell" id="sellBtn">
                <div class="price" id="sellPrice">1.08498</div>
                <div class="label">Sell / Short</div>
              </div>
            </div>

            <div class="form-group">
              <div class="form-label">
                <span>Lot Size</span>
                <span id="lotValue">\$100,000 notional</span>
              </div>
              <input type="number" class="form-input" id="lotInput" value="1.00" step="0.01" min="0.01">
              <div class="quick-lots">
                <button class="quick-lot" data-lot="0.01">0.01</button>
                <button class="quick-lot" data-lot="0.1">0.10</button>
                <button class="quick-lot" data-lot="0.5">0.50</button>
                <button class="quick-lot" data-lot="1">1.00</button>
                <button class="quick-lot" data-lot="5">5.00</button>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <div class="form-label">
                  <span>Stop Loss</span>
                  <span id="slPips">0 pips</span>
                </div>
                <div class="input-with-icon">
                  <input type="number" class="form-input" id="slInput" placeholder="Price" step="0.00001">
                  <span class="icon">üîª</span>
                </div>
              </div>
              <div class="form-group">
                <div class="form-label">
                  <span>Take Profit</span>
                  <span id="tpPips">0 pips</span>
                </div>
                <div class="input-with-icon">
                  <input type="number" class="form-input" id="tpInput" placeholder="Price" step="0.00001">
                  <span class="icon">üî∫</span>
                </div>
              </div>
            </div>

            <div class="form-group">
              <div class="form-label">
                <span>Leverage</span>
              </div>
              <select class="form-input" id="leverageSelect">
                <option value="10">1:10</option>
                <option value="20" selected>1:20</option>
                <option value="30">1:30</option>
                <option value="50">1:50</option>
                <option value="100">1:100</option>
              </select>
            </div>

            <div class="trade-summary">
              <div class="summary-row">
                <span class="label">Required Margin</span>
                <span class="value" id="reqMargin">\$5,000.00</span>
              </div>
              <div class="summary-row">
                <span class="label">Pip Value</span>
                <span class="value" id="pipValue">\$10.00</span>
              </div>
              <div class="summary-row">
                <span class="label">Spread Cost</span>
                <span class="value" id="spreadCost">\$11.00</span>
              </div>
              <div class="summary-row total">
                <span class="label">Risk/Reward</span>
                <span class="value" id="rrRatio">‚Äî</span>
              </div>
            </div>

            <button class="submit-trade buy" id="submitTrade">
              <span>üü¢</span> Place Buy Order
            </button>
          </div>

          <!-- Positions Tab -->
          <div class="tab-pane" id="positionsPane">
            <div class="positions-list" id="positionsList"></div>
          </div>

          <!-- Alerts Tab -->
          <div class="tab-pane" id="alertsPane">
            <div class="alert-form">
              <div class="form-group">
                <div class="form-label"><span>Alert When Price</span></div>
                <select class="form-input" id="alertCondition">
                  <option value="above">Goes Above</option>
                  <option value="below">Goes Below</option>
                  <option value="crosses">Crosses</option>
                </select>
              </div>
              <div class="form-group">
                <div class="form-label"><span>Price Level</span></div>
                <input type="number" class="form-input" id="alertPrice" placeholder="Enter price" step="0.00001">
              </div>
              <button class="btn btn-primary" style="width: 100%; margin-top: 8px;" id="addAlertBtn">
                üîî Create Alert
              </button>
            </div>

            <div class="panel-header" style="padding: 0 0 12px 0; border: none;">
              <div class="panel-title">Active Alerts</div>
              <span class="badge" id="alertCount">0</span>
            </div>

            <div class="alerts-list" id="alertsList">
              <div class="empty-state">
                <div class="icon">üîî</div>
                <div class="title">No alerts yet</div>
                <div class="desc">Create price alerts to get notified</div>
              </div>
            </div>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <div class="toast-container">
    <div class="toast" id="toast">
      <span class="toast-icon" id="toastIcon">‚úÖ</span>
      <span class="toast-message" id="toastMessage">Order placed successfully</span>
      <button class="toast-close" id="toastClose">√ó</button>
    </div>
  </div>

  <script>
    // ===============================
    // DATA MODEL
    // ===============================
    const pairs = [
      { symbol: 'EUR/USD', base: 'EUR', quote: 'USD', flags: 'üá™üá∫üá∫üá∏', name: 'Euro vs US Dollar', type: 'Major', price: 1.0850, spread: 1.1, vol: 0.00045 },
      { symbol: 'GBP/USD', base: 'GBP', quote: 'USD', flags: 'üá¨üáßüá∫üá∏', name: 'Pound vs US Dollar', type: 'Major', price: 1.2650, spread: 1.4, vol: 0.00055 },
      { symbol: 'USD/JPY', base: 'USD', quote: 'JPY', flags: 'üá∫üá∏üáØüáµ', name: 'US Dollar vs Yen', type: 'Major', price: 150.35, spread: 1.2, vol: 0.08 },
      { symbol: 'USD/CHF', base: 'USD', quote: 'CHF', flags: 'üá∫üá∏üá®üá≠', name: 'US Dollar vs Franc', type: 'Major', price: 0.8812, spread: 1.3, vol: 0.00040 },
      { symbol: 'AUD/USD', base: 'AUD', quote: 'USD', flags: 'üá¶üá∫üá∫üá∏', name: 'Aussie vs US Dollar', type: 'Major', price: 0.6550, spread: 1.5, vol: 0.00050 },
      { symbol: 'USD/CAD', base: 'USD', quote: 'CAD', flags: 'üá∫üá∏üá®üá¶', name: 'US Dollar vs Loonie', type: 'Major', price: 1.3550, spread: 1.4, vol: 0.00045 },
      { symbol: 'NZD/USD', base: 'NZD', quote: 'USD', flags: 'üá≥üáøüá∫üá∏', name: 'Kiwi vs US Dollar', type: 'Major', price: 0.6100, spread: 1.8, vol: 0.00055 },
      { symbol: 'EUR/GBP', base: 'EUR', quote: 'GBP', flags: 'üá™üá∫üá¨üáß', name: 'Euro vs Pound', type: 'Cross', price: 0.8580, spread: 1.5, vol: 0.00035 },
      { symbol: 'EUR/JPY', base: 'EUR', quote: 'JPY', flags: 'üá™üá∫üáØüáµ', name: 'Euro vs Yen', type: 'Cross', price: 163.10, spread: 1.8, vol: 0.09 },
      { symbol: 'GBP/JPY', base: 'GBP', quote: 'JPY', flags: 'üá¨üáßüáØüáµ', name: 'Pound vs Yen', type: 'Cross', price: 190.20, spread: 2.2, vol: 0.12 },
      { symbol: 'AUD/JPY', base: 'AUD', quote: 'JPY', flags: 'üá¶üá∫üáØüáµ', name: 'Aussie vs Yen', type: 'Cross', price: 98.50, spread: 2.0, vol: 0.07 },
      { symbol: 'EUR/CHF', base: 'EUR', quote: 'CHF', flags: 'üá™üá∫üá®üá≠', name: 'Euro vs Franc', type: 'Cross', price: 0.9560, spread: 1.6, vol: 0.00038 }
    ];

    const state = {
      selectedPair: 0,
      direction: 'buy',
      positions: [],
      alerts: [],
      balance: 100000,
      equity: 100000,
      openPnl: 0,
      marginUsed: 0,
      tickSpeed: 1000,
      chartStyle: 'candle',
      indicators: { ma: false, ema: false, bb: false, rsi: true },
      priceHistory: {},
      candles: {}
    };

    // ===============================
    // INIT PRICE HISTORY
    // ===============================
    function initPriceData() {
      pairs.forEach((pair, idx) => {
        const history = [];
        const candles = [];
        let price = pair.price;

        for (let i = 0; i < 120; i++) {
          const change = (Math.random() - 0.5) * pair.vol * 2;
          price += change;
          history.push({ time: Date.now() - (120 - i) * 1000, price });

          if (i % 5 === 0) {
            const o = price;
            const h = price + Math.random() * pair.vol;
            const l = price - Math.random() * pair.vol;
            const c = price + (Math.random() - 0.5) * pair.vol;
            candles.push({ time: Date.now() - (120 - i) * 1000, o, h, l, c });
          }
        }

        state.priceHistory[idx] = history;
        state.candles[idx] = candles;
        pairs[idx].openPrice = history[0].price;
        pairs[idx].dayHigh = Math.max(...history.map(h => h.price));
        pairs[idx].dayLow = Math.min(...history.map(h => h.price));
      });
    }

    // ===============================
    // UTILITIES
    // ===============================
    const formatPrice = (price, symbol) =>
      symbol.includes('JPY') ? price.toFixed(3) : price.toFixed(5);

    const formatMoney = (val) =>
      '$' + val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    const pipMultiplier = (symbol) => (symbol.includes('JPY') ? 0.01 : 0.0001);

    // ===============================
    // INDICATORS
    // ===============================
    function calcRSI(prices, period = 14) {
      if (prices.length < period + 1) return 50;
      let gains = 0, losses = 0;
      for (let i = prices.length - period; i < prices.length; i++) {
        const diff = prices[i].price - prices[i - 1].price;
        if (diff > 0) gains += diff;
        else losses -= diff;
      }
      const avgGain = gains / period;
      const avgLoss = losses / period;
      if (avgLoss === 0) return 100;
      const rs = avgGain / avgLoss;
      return 100 - (100 / (1 + rs));
    }

    function calcMA(prices, period = 20) {
      if (prices.length < period) return [];
      const out = [];
      for (let i = period - 1; i < prices.length; i++) {
        const slice = prices.slice(i - period + 1, i + 1);
        const avg = slice.reduce((s, p) => s + p.price, 0) / period;
        out.push({ time: prices[i].time, value: avg });
      }
      return out;
    }

    function calcEMA(prices, period = 50) {
      if (prices.length < period) return [];
      const k = 2 / (period + 1);
      const base = prices.slice(0, period);
      let prev = base.reduce((s, p) => s + p.price, 0) / period;
      const ema = [{ time: prices[period - 1].time, value: prev }];
      for (let i = period; i < prices.length; i++) {
        const val = prices[i].price * k + prev * (1 - k);
        ema.push({ time: prices[i].time, value: val });
        prev = val;
      }
      return ema;
    }

    function calcBB(prices, period = 20) {
      const ma = calcMA(prices, period);
      if (!ma.length) return { upper: [], lower: [], middle: ma };
      const upper = [], lower = [];
      for (let i = period - 1; i < prices.length; i++) {
        const slice = prices.slice(i - period + 1, i + 1).map(h => h.price);
        const mean = slice.reduce((s, p) => s + p, 0) / period;
        const variance = slice.reduce((s, p) => s + Math.pow(p - mean, 2), 0) / period;
        const std = Math.sqrt(variance);
        upper.push({ value: mean + std * 2 });
        lower.push({ value: mean - std * 2 });
      }
      return { upper, lower, middle: ma };
    }

    // ===============================
    // WATCHLIST
    // ===============================
    function renderWatchlist() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const container = document.getElementById('watchlist');
      const filtered = pairs.filter(p =>
        p.symbol.toLowerCase().includes(search) ||
        p.name.toLowerCase().includes(search)
      );

      container.innerHTML = filtered.map(pair => {
        const idx = pairs.indexOf(pair);
        const history = state.priceHistory[idx];
        const last = history[history.length - 1].price;
        const change = ((last - pair.openPrice) / pair.openPrice) * 100;
        const active = idx === state.selectedPair;

        return `
          <div class="watchlist-item ${active ? 'active' : ''}" data-idx="${idx}">
            <div class="pair-info">
              <span class="pair-flags">${pair.flags}</span>
              <div>
                <div class="pair-symbol">${pair.symbol}</div>
                <div class="pair-name">${pair.type}</div>
              </div>
            </div>
            <div class="pair-price">${formatPrice(last, pair.symbol)}</div>
            <div class="pair-change ${change >= 0 ? 'positive' : 'negative'}">
              ${change >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(change).toFixed(2)}%
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('pairCount').textContent = pairs.length + ' pairs';

      document.querySelectorAll('.watchlist-item').forEach(item => {
        item.addEventListener('click', () => {
          state.selectedPair = parseInt(item.dataset.idx, 10);
          renderWatchlist();
          updateChartHeader();
          drawChart();
          updateTradePanel();
        });
      });
    }

    // ===============================
    // CHART HEADER
    // ===============================
    function updateChartHeader() {
      const pair = pairs[state.selectedPair];
      const history = state.priceHistory[state.selectedPair];
      const last = history[history.length - 1].price;
      const change = last - pair.openPrice;
      const pct = (change / pair.openPrice) * 100;
      const spreadPx = pair.spread * pipMultiplier(pair.symbol);

      document.getElementById('chartFlags').textContent = pair.flags;
      document.getElementById('chartPairName').textContent = pair.symbol;
      document.getElementById('chartPairDesc').textContent = `${pair.name} ‚Ä¢ ${pair.type}`;
      document.getElementById('chartPrice').textContent = formatPrice(last, pair.symbol);

      const changeEl = document.getElementById('chartChange');
      changeEl.innerHTML = `
        <span>${pct >= 0 ? '‚ñ≤' : '‚ñº'} ${pct >= 0 ? '+' : ''}${pct.toFixed(3)}%</span>
        <span>(${change >= 0 ? '+' : ''}${formatPrice(change, pair.symbol)})</span>
      `;
      changeEl.className = `chart-price-change ${pct >= 0 ? 'positive' : 'negative'}`;

      document.getElementById('spreadValue').textContent = `${pair.spread.toFixed(1)} pips`;
      document.getElementById('bidPrice').textContent = formatPrice(last, pair.symbol);
      document.getElementById('askPrice').textContent = formatPrice(last + spreadPx, pair.symbol);
      document.getElementById('dayRange').textContent =
        `${formatPrice(pair.dayLow, pair.symbol)} - ${formatPrice(pair.dayHigh, pair.symbol)}`;

      const rsi = calcRSI(history);
      document.getElementById('rsiValue').textContent = rsi.toFixed(1);

      const candles = state.candles[state.selectedPair];
      if (candles.length) {
        const c = candles[candles.length - 1];
        document.getElementById('oOpen').textContent = formatPrice(c.o, pair.symbol);
        document.getElementById('oHigh').textContent = formatPrice(c.h, pair.symbol);
        document.getElementById('oLow').textContent = formatPrice(c.l, pair.symbol);
        document.getElementById('oClose').textContent = formatPrice(c.c, pair.symbol);
      }
    }

    // ===============================
    // CHART DRAWING
    // ===============================
    function drawChart() {
      const mainCanvas = document.getElementById('mainChart');
      const rsiCanvas = document.getElementById('rsiChart');
      const ctx = mainCanvas.getContext('2d');
      const rsiCtx = rsiCanvas.getContext('2d');
      const rect = mainCanvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;

      mainCanvas.width = rect.width * dpr;
      mainCanvas.height = rect.height * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.clearRect(0, 0, rect.width, rect.height);

      const w = rect.width;
      const h = rect.height - 70;
      const padding = { top: 20, right: 70, bottom: 30, left: 10 };

      const pair = pairs[state.selectedPair];
      const history = state.priceHistory[state.selectedPair];
      const candles = state.candles[state.selectedPair];

      const prices = history.map(p => p.price);
      const minPrice = Math.min(...prices) * 0.9995;
      const maxPrice = Math.max(...prices) * 1.0005;

      const toX = (i, arr) =>
        padding.left + (i / (arr.length - 1)) * (w - padding.left - padding.right);
      const toY = (price) =>
        padding.top + ((maxPrice - price) / (maxPrice - minPrice)) * h;

      // Grid
      ctx.strokeStyle = 'rgba(42, 52, 68, 0.55)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 5; i++) {
        const y = padding.top + (i / 5) * h;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(w - padding.right, y);
        ctx.stroke();

        const p = maxPrice - (i / 5) * (maxPrice - minPrice);
        ctx.fillStyle = '#5a6270';
        ctx.font = '10px monospace';
        ctx.textAlign = 'left';
        ctx.fillText(formatPrice(p, pair.symbol), w - padding.right + 5, y + 3);
      }

      // Price series
      if (state.chartStyle === 'candle' && candles.length) {
        const cw = Math.max(4, (w - padding.left - padding.right) / candles.length - 2);
        candles.forEach((c, i) => {
          const x = padding.left + (i / (candles.length - 1)) * (w - padding.left - padding.right);
          const green = c.c >= c.o;
          ctx.strokeStyle = green ? '#00d26a' : '#ff4757';
          ctx.fillStyle = green ? '#00d26a' : '#ff4757';

          // wick
          ctx.beginPath();
          ctx.moveTo(x, toY(c.h));
          ctx.lineTo(x, toY(c.l));
          ctx.stroke();

          const top = toY(Math.max(c.o, c.c));
          const bottom = toY(Math.min(c.o, c.c));
          ctx.fillRect(x - cw / 2, top, cw, Math.max(1, bottom - top));
        });
      } else {
        ctx.strokeStyle = '#00d26a';
        ctx.lineWidth = 2;
        ctx.beginPath();
        history.forEach((pt, i) => {
          const x = toX(i, history);
          const y = toY(pt.price);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();

        ctx.lineTo(toX(history.length - 1, history), h + padding.top);
        ctx.lineTo(toX(0, history), h + padding.top);
        ctx.closePath();
        const grad = ctx.createLinearGradient(0, padding.top, 0, h + padding.top);
        grad.addColorStop(0, 'rgba(0,210,106,0.35)');
        grad.addColorStop(1, 'rgba(0,210,106,0)');
        ctx.fillStyle = grad;
        ctx.fill();
      }

      // MA
      if (state.indicators.ma) {
        const ma = calcMA(history, 20);
        if (ma.length) {
          ctx.strokeStyle = '#ffc107';
          ctx.lineWidth = 1.5;
          ctx.beginPath();
          ma.forEach((p, i) => {
            const x = toX(i + 19, history);
            const y = toY(p.value);
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          });
          ctx.stroke();
        }
      }

      // EMA
      if (state.indicators.ema) {
        const ema = calcEMA(history, 50);
        if (ema.length) {
          ctx.strokeStyle = '#9b59b6';
          ctx.lineWidth = 1.5;
          ctx.beginPath();
          ema.forEach((p, i) => {
            const x = toX(i + 49, history);
            const y = toY(p.value);
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          });
          ctx.stroke();
        }
      }

      // Bollinger
      if (state.indicators.bb) {
        const bb = calcBB(history, 20);
        if (bb.upper.length) {
          ctx.strokeStyle = 'rgba(52,152,255,0.6)';
          ctx.lineWidth = 1;
          ctx.setLineDash([5, 5]);
          ctx.beginPath();
          bb.upper.forEach((p, i) => {
            const x = toX(i + 19, history);
            const y = toY(p.value);
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          });
          ctx.stroke();

          ctx.beginPath();
          bb.lower.forEach((p, i) => {
            const x = toX(i + 19, history);
            const y = toY(p.value);
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          });
          ctx.stroke();
          ctx.setLineDash([]);
        }
      }

      // RSI
      if (state.indicators.rsi) {
        const rRect = rsiCanvas.getBoundingClientRect();
        rsiCanvas.width = rRect.width * dpr;
        rsiCanvas.height = 60 * dpr;
        rsiCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
        rsiCtx.clearRect(0, 0, rRect.width, 60);
        rsiCtx.fillStyle = 'rgba(15,22,41,0.95)';
        rsiCtx.fillRect(0, 0, rRect.width, 60);

        rsiCtx.strokeStyle = 'rgba(255,71,87,0.3)';
        rsiCtx.beginPath();
        rsiCtx.moveTo(padding.left, 12);
        rsiCtx.lineTo(rRect.width - padding.right, 12);
        rsiCtx.stroke();

        rsiCtx.strokeStyle = 'rgba(0,210,106,0.3)';
        rsiCtx.beginPath();
        rsiCtx.moveTo(padding.left, 48);
        rsiCtx.lineTo(rRect.width - padding.right, 48);
        rsiCtx.stroke();

        const rValues = [];
        for (let i = 15; i < history.length; i++) {
          rValues.push(calcRSI(history.slice(0, i + 1)));
        }

        if (rValues.length) {
          rsiCtx.strokeStyle = '#3498ff';
          rsiCtx.lineWidth = 1.5;
          rsiCtx.beginPath();
          rValues.forEach((val, i) => {
            const x = padding.left + ((i + 15) / (history.length - 1)) *
              (rRect.width - padding.left - padding.right);
            const y = 60 - (val / 100) * 60;
            if (i === 0) rsiCtx.moveTo(x, y);
            else rsiCtx.lineTo(x, y);
          });
          rsiCtx.stroke();
        }

        rsiCtx.fillStyle = '#5a6270';
        rsiCtx.font = '9px sans-serif';
        rsiCtx.fillText('70', rRect.width - padding.right + 5, 14);
        rsiCtx.fillText('30', rRect.width - padding.right + 5, 50);
      }
    }

    // ===============================
    // TRADE PANEL & ACCOUNT
    // ===============================
    function updateTradePanel() {
      const pair = pairs[state.selectedPair];
      const history = state.priceHistory[state.selectedPair];
      const last = history[history.length - 1].price;
      const spreadPx = pair.spread * pipMultiplier(pair.symbol);

      document.getElementById('buyPrice').textContent = formatPrice(last + spreadPx, pair.symbol);
      document.getElementById('sellPrice').textContent = formatPrice(last, pair.symbol);

      const lots = parseFloat(document.getElementById('lotInput').value) || 1;
      const lev = parseInt(document.getElementById('leverageSelect').value, 10) || 20;
      const notional = lots * 100000;
      const margin = notional / lev;

      document.getElementById('lotValue').textContent = formatMoney(notional) + ' notional';
      document.getElementById('reqMargin').textContent = formatMoney(margin);
      document.getElementById('pipValue').textContent = formatMoney(lots * 10);
      document.getElementById('spreadCost').textContent = formatMoney(pair.spread * lots * 10);

      const sl = parseFloat(document.getElementById('slInput').value);
      const tp = parseFloat(document.getElementById('tpInput').value);
      const pip = pipMultiplier(pair.symbol);

      if (sl && tp) {
        const riskPips = Math.abs(last - sl) / pip;
        const rewardPips = Math.abs(tp - last) / pip;
        document.getElementById('slPips').textContent = riskPips.toFixed(0) + ' pips';
        document.getElementById('tpPips').textContent = rewardPips.toFixed(0) + ' pips';
        document.getElementById('rrRatio').textContent =
          riskPips > 0 ? `1:${(rewardPips / riskPips).toFixed(1)}` : '‚Äî';
      } else {
        document.getElementById('slPips').textContent = '0 pips';
        document.getElementById('tpPips').textContent = '0 pips';
        document.getElementById('rrRatio').textContent = '‚Äî';
      }

      const submitBtn = document.getElementById('submitTrade');
      submitBtn.className = `submit-trade ${state.direction}`;
      submitBtn.innerHTML = state.direction === 'buy'
        ? '<span>üü¢</span> Place Buy Order'
        : '<span>üî¥</span> Place Sell Order';
    }

    function updateAccount() {
      let pnl = 0;
      state.positions.forEach(pos => {
        const hist = state.priceHistory[pos.pairIdx];
        const pair = pairs[pos.pairIdx];
        const last = hist[hist.length - 1].price;
        const pip = pipMultiplier(pair.symbol);
        const pips = pos.direction === 'buy'
          ? (last - pos.entryPrice) / pip
          : (pos.entryPrice - last) / pip;
        pos.pnl = pips * pos.lots * 10;
        pnl += pos.pnl;
      });

      state.openPnl = pnl;
      state.equity = state.balance + pnl;
      state.marginUsed = state.positions.reduce((s, p) => s + p.margin, 0);

      document.getElementById('accountBalance').textContent = formatMoney(state.balance);
      document.getElementById('equityValue').textContent = formatMoney(state.equity);
      document.getElementById('marginValue').textContent = formatMoney(state.marginUsed);
      document.getElementById('freeMargin').textContent =
        formatMoney(state.equity - state.marginUsed);

      const pnlEl = document.getElementById('openPnl');
      pnlEl.textContent = (pnl >= 0 ? '+' : '') + formatMoney(pnl);
      pnlEl.className = pnl >= 0 ? 'positive' : 'negative';

      const diff = state.equity - 100000;
      const pct = (diff / 100000) * 100;
      const chEl = document.getElementById('accountChange');
      chEl.textContent =
        `${pct >= 0 ? '‚ñ≤' : '‚ñº'} ${pct >= 0 ? '+' : ''}${formatMoney(diff)} (${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%)`;
      chEl.className = `balance-change ${pct >= 0 ? 'positive' : 'negative'}`;
    }

    function renderPositions() {
      const container = document.getElementById('positionsList');
      if (!state.positions.length) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">üìä</div>
            <div class="title">No open positions</div>
            <div class="desc">Place a trade to see it here</div>
          </div>`;
        return;
      }

      container.innerHTML = state.positions.map((pos, idx) => {
        const pair = pairs[pos.pairIdx];
        const hist = state.priceHistory[pos.pairIdx];
        const last = hist[hist.length - 1].price;
        return `
          <div class="position-card">
            <div class="position-header">
              <div class="position-pair">
                <span class="flags">${pair.flags}</span>
                <span class="symbol">${pair.symbol}</span>
              </div>
              <span class="position-dir ${pos.direction}">${pos.direction.toUpperCase()}</span>
            </div>
            <div class="position-details">
              <div class="position-detail">
                <span class="label">Entry</span>
                <span class="value">${formatPrice(pos.entryPrice, pair.symbol)}</span>
              </div>
              <div class="position-detail">
                <span class="label">Current</span>
                <span class="value">${formatPrice(last, pair.symbol)}</span>
              </div>
              <div class="position-detail">
                <span class="label">Lots</span>
                <span class="value">${pos.lots.toFixed(2)}</span>
              </div>
              <div class="position-detail">
                <span class="label">Margin</span>
                <span class="value">${formatMoney(pos.margin)}</span>
              </div>
            </div>
            <div class="position-pnl">
              <span class="pnl-value ${pos.pnl >= 0 ? 'positive' : 'negative'}">
                ${pos.pnl >= 0 ? '+' : ''}${formatMoney(pos.pnl)}
              </span>
              <button class="close-position" data-idx="${idx}">Close Position</button>
            </div>
          </div>`;
      }).join('');

      document.querySelectorAll('.close-position').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx, 10);
          const pos = state.positions[idx];
          state.balance += pos.pnl;
          state.positions.splice(idx, 1);
          renderPositions();
          updateAccount();
          showToast('Position closed', pos.pnl >= 0 ? '‚úÖ' : '‚ùå');
        });
      });
    }

    // ===============================
    // ALERTS
    // ===============================
    function renderAlerts() {
      const container = document.getElementById('alertsList');
      document.getElementById('alertCount').textContent = state.alerts.length;
      if (!state.alerts.length) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">üîî</div>
            <div class="title">No alerts yet</div>
            <div class="desc">Create price alerts to get notified</div>
          </div>`;
        return;
      }
      container.innerHTML = state.alerts.map((al, idx) => {
        const pair = pairs[al.pairIdx];
        return `
          <div class="alert-item">
            <div class="alert-info">
              <span class="alert-pair">${pair.symbol}</span>
              <span class="alert-condition">${al.condition} ${formatPrice(al.price, pair.symbol)}</span>
            </div>
            <button class="alert-delete" data-idx="${idx}">√ó</button>
          </div>`;
      }).join('');

      document.querySelectorAll('.alert-delete').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx, 10);
          state.alerts.splice(idx, 1);
          renderAlerts();
        });
      });
    }

    function checkAlerts() {
      state.alerts = state.alerts.filter(al => {
        const hist = state.priceHistory[al.pairIdx];
        const price = hist[hist.length - 1].price;
        const prev = hist[hist.length - 2]?.price ?? price;
        let fire = false;
        if (al.condition === 'above' && price >= al.price && prev < al.price) fire = true;
        if (al.condition === 'below' && price <= al.price && prev > al.price) fire = true;
        if (al.condition === 'crosses' &&
          ((price >= al.price && prev < al.price) || (price <= al.price && prev > al.price))) fire = true;
        if (fire) {
          showToast(`${pairs[al.pairIdx].symbol} ${al.condition} ${formatPrice(al.price, pairs[al.pairIdx].symbol)}`, 'üîî');
          return false;
        }
        return true;
      });
      renderAlerts();
    }

    // ===============================
    // TOAST & CLOCK
    // ===============================
    function showToast(msg, icon = '‚úÖ') {
      const toast = document.getElementById('toast');
      document.getElementById('toastMessage').textContent = msg;
      document.getElementById('toastIcon').textContent = icon;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function updateClock() {
      const d = new Date();
      const h = String(d.getUTCHours()).padStart(2, '0');
      const m = String(d.getUTCMinutes()).padStart(2, '0');
      const s = String(d.getUTCSeconds()).padStart(2, '0');
      document.getElementById('marketClock').textContent = `${h}:${m}:${s} UTC`;

      const hour = d.getUTCHours();
      let session = 'üåç London';
      if (hour < 8) session = 'üåè Tokyo';
      else if (hour >= 13 && hour < 22) session = 'üåé New York';
      document.getElementById('sessionLabel').textContent = session;
    }

    // ===============================
    // TICK ENGINE
    // ===============================
    let tickInterval = null;
    function tick() {
      pairs.forEach((pair, idx) => {
        const hist = state.priceHistory[idx];
        const last = hist[hist.length - 1].price;
        const change = (Math.random() - 0.5) * pair.vol * 2;
        const next = Math.max(pair.price * 0.9, Math.min(pair.price * 1.1, last + change));
        hist.push({ time: Date.now(), price: next });
        if (hist.length > 240) hist.shift();
        pair.dayHigh = Math.max(pair.dayHigh, next);
        pair.dayLow = Math.min(pair.dayLow, next);

        const candles = state.candles[idx];
        const lastC = candles[candles.length - 1];
        if (Date.now() - lastC.time > 5000) {
          candles.push({ time: Date.now(), o: next, h: next, l: next, c: next });
          if (candles.length > 80) candles.shift();
        } else {
          lastC.h = Math.max(lastC.h, next);
          lastC.l = Math.min(lastC.l, next);
          lastC.c = next;
        }
      });

      renderWatchlist();
      updateChartHeader();
      drawChart();
      updateTradePanel();
      updateAccount();
      checkAlerts();
    }

    // ===============================
    // EVENTS
    // ===============================
    function setupEvents() {
      document.getElementById('searchInput').addEventListener('input', renderWatchlist);

      document.getElementById('buyBtn').addEventListener('click', () => {
        state.direction = 'buy';
        document.getElementById('buyBtn').classList.add('active');
        document.getElementById('sellBtn').classList.remove('active');
        updateTradePanel();
      });

      document.getElementById('sellBtn').addEventListener('click', () => {
        state.direction = 'sell';
        document.getElementById('sellBtn').classList.add('active');
        document.getElementById('buyBtn').classList.remove('active');
        updateTradePanel();
      });

      document.querySelectorAll('.quick-lot').forEach(btn => {
        btn.addEventListener('click', () => {
          document.getElementById('lotInput').value = btn.dataset.lot;
          updateTradePanel();
        });
      });

      ['lotInput', 'leverageSelect', 'slInput', 'tpInput'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateTradePanel);
        document.getElementById(id).addEventListener('change', updateTradePanel);
      });

      document.getElementById('submitTrade').addEventListener('click', () => {
        const pair = pairs[state.selectedPair];
        const hist = state.priceHistory[state.selectedPair];
        const last = hist[hist.length - 1].price;
        const spreadPx = pair.spread * pipMultiplier(pair.symbol);
        const lots = parseFloat(document.getElementById('lotInput').value) || 1;
        const lev = parseInt(document.getElementById('leverageSelect').value, 10) || 20;
        const entry = state.direction === 'buy' ? last + spreadPx : last;
        const margin = (lots * 100000) / lev;

        if (margin > state.equity - state.marginUsed) {
          showToast('Insufficient margin', '‚ùå');
          return;
        }

        state.positions.push({
          pairIdx: state.selectedPair,
          direction: state.direction,
          entryPrice: entry,
          lots,
          margin,
          pnl: 0,
          time: new Date()
        });

        renderPositions();
        updateAccount();
        showToast(`${state.direction.toUpperCase()} ${lots} ${pair.symbol} @ ${formatPrice(entry, pair.symbol)}`, '‚úÖ');
      });

      document.getElementById('addAlertBtn').addEventListener('click', () => {
        const price = parseFloat(document.getElementById('alertPrice').value);
        const condition = document.getElementById('alertCondition').value;
        if (!price) {
          showToast('Enter a price level', '‚ùå');
          return;
        }
        state.alerts.push({ pairIdx: state.selectedPair, price, condition });
        document.getElementById('alertPrice').value = '';
        renderAlerts();
        showToast('Alert created', 'üîî');
      });

      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab + 'Pane').classList.add('active');
        });
      });

      document.querySelectorAll('.toolbar-btn[data-tf]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.toolbar-btn[data-tf]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
      });

      document.getElementById('lineBtn').addEventListener('click', () => {
        state.chartStyle = 'line';
        document.getElementById('lineBtn').classList.add('active');
        document.getElementById('candleBtn').classList.remove('active');
        drawChart();
      });

      document.getElementById('candleBtn').addEventListener('click', () => {
        state.chartStyle = 'candle';
        document.getElementById('candleBtn').classList.add('active');
        document.getElementById('lineBtn').classList.remove('active');
        drawChart();
      });

      ['ma', 'ema', 'bb', 'rsi'].forEach(ind => {
        document.getElementById(ind + 'Tag').addEventListener('click', () => {
          state.indicators[ind] = !state.indicators[ind];
          document.getElementById(ind + 'Tag').classList.toggle('active', state.indicators[ind]);
          drawChart();
        });
      });

      let speed = state.tickSpeed;
      document.getElementById('speedBtn').addEventListener('click', () => {
        if (speed === 1000) speed = 500;
        else if (speed === 500) speed = 250;
        else speed = 1000;
        document.getElementById('speedBtn').textContent =
          speed === 1000 ? '‚ö° 1x Speed' : speed === 500 ? '‚ö° 2x Speed' : '‚ö° 4x Speed';
        clearInterval(tickInterval);
        tickInterval = setInterval(tick, speed);
      });

      document.getElementById('toastClose').addEventListener('click', () => {
        document.getElementById('toast').classList.remove('show');
      });

      window.addEventListener('resize', drawChart);
    }

    // ===============================
    // INIT
    // ===============================
    function init() {
      initPriceData();
      renderWatchlist();
      updateChartHeader();
      drawChart();
      updateTradePanel();
      updateAccount();
      renderPositions();
      renderAlerts();
      updateClock();
      setupEvents();
      tickInterval = setInterval(tick, state.tickSpeed);
      setInterval(updateClock, 1000);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
